# EnterpriseApp

This repository is a compact, enterprise-style ASP.NET Core 6 sample application created to demonstrate patterns, libraries, and migration pain points you commonly see in corporate codebases. It intentionally includes a few packages and patterns known to cause friction when upgrading to later .NET versions (for example, .NET 10). The project is small but runnable and includes an automated integration check that exercises authentication and a protected endpoint.

## What I implemented in this workspace

- Core web app (`src/EnterpriseApp`) using ASP.NET Core 6 with `Startup`/`Program` bootstrap.
- Demonstrations of libraries that often require attention when migrating:
	- Autofac (dependency injection)
	- Newtonsoft.Json (legacy JSON serializer)
	- System.Drawing.Common (platform-specific image-generation APIs)
	- EF Core (SQLite) for database access
	- IdentityServer4 (legacy authentication server)
- An integration harness (`tests/integration-runner`) that starts the web app on a free port, obtains a `client_credentials` token from the local IdentityServer4, and then calls a protected endpoint.
- An xUnit test project (`tests/EnterpriseApp.IntegrationRunner.Test`) that runs the integration harness as part of `dotnet test` for CI.

## High-level architecture

- ASP.NET Core Web API controllers backed by a small static landing page (`wwwroot/index.html`).
- Autofac integrated via `Autofac.Extensions.DependencyInjection` and an `Autofac` module.
- `IProductService` / `ProductService` interact with Entity Framework Core and include a contrived System.Drawing usage to highlight Windows platform-specific behavior.
- EF Core with SQLite (`AppDbContext`) seeded at startup (`app.db`).
- IdentityServer4 in-memory demo configured inside the same process to show token issuance and validation. The sample config is intentionally simplified and **not secure for production**.
- A separate integration runner and an xUnit test that launches it (process-based test) to avoid testhost assembly resolution problems that can happen with in-process tests.

## Key components

- `src/EnterpriseApp/Program.cs` - Host bootstrap, Autofac service provider factory hooking, DB seed, and app run.
- `src/EnterpriseApp/Startup.cs` - All service registrations: controllers (AddNewtonsoftJson), EF Core (SQLite), Swagger (endpoint UI), IdentityServer4 demo, JwtBearer authentication, and Autofac module registration.
- `src/EnterpriseApp/Controllers/ProductsController.cs` - CRUD for `Product` (GET/POST).
- `src/EnterpriseApp/Controllers/ProtectedController.cs` - `GET /protected/secret` protected with `[Authorize]`.
- `src/EnterpriseApp/Controllers/ProjectInfoController.cs` - Renders `README.md` into HTML using Markdig for the landing page.
- `src/EnterpriseApp/Controllers/DiagnosticController.cs` - Library demos: `/diag/json` (Newtonsoft serialization) and `/diag/resolve` (Autofac resolution).
- `src/EnterpriseApp/Controllers/ImageController.cs` - Demo of `System.Drawing.Common` generating a PNG, a Windows-only behavior.
- `src/EnterpriseApp/Services/ProductService.cs` - EF-backed service and small `System.Drawing` example.
- `src/EnterpriseApp/Data/AppDbContext.cs` - Sets EF Core DbContext.
- `tests/integration-runner/Program.cs` - Starts the web app on a free port, polls readiness, requests a token, calls `/protected/secret`, streamslogs, and exits with exit codes.
- `tests/EnterpriseApp.IntegrationRunner.Test` - xUnit project that runs the integration-runner as a process and asserts a zero exit code so `dotnet test` can be used in CI.

## Endpoints of interest

- `GET /` -> landing page (serves `wwwroot/index.html`)
- `GET /project-info` -> rendered `README.md` as HTML
- `GET /swagger` -> Swagger UI
- `GET /api/products` -> list products (Product: Id, Name, Price)
- `POST /api/products` -> create a product
- `GET /image/thumb` -> small PNG image generated by `System.Drawing.Common` (Windows-only)
- `GET /diag/json` -> NewtonSoft-serialized diagnostic JSON
- `GET /diag/resolve` -> prints whether `IProductService` can be resolved from Autofac
- `GET /protected/secret` -> protected endpoint (requires bearer token from demo IdentityServer4)

## Running locally

1. Start the app for manual exploration:

```powershell
cd src/EnterpriseApp
dotnet restore
dotnet build
dotnet run --urls "http://localhost:5000"
```

2. Open these pages:

- Landing page: http://localhost:5000
- Swagger: http://localhost:5000/swagger
- Project info (HTML rendering of `README.md`): http://localhost:5000/project-info

## Running the automated integration check (locally or CI)

- Run the integration-runner directly:

```powershell
dotnet run --project tests/integration-runner
```

Or

- Run the xUnit wrapper so it appears in `dotnet test` and CI:

```powershell
dotnet test
```

## Notes, caveats and next steps

- The demo IdentityServer4 configuration is intentionally simplified (in-memory clients and resources). **Do not use it in production.**